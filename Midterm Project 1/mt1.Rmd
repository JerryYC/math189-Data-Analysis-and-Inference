---
title: "Midterm Project 1"
author: 'Jerry Chan'
output:
  html_document:
    df_print: paged
header-includes: \usepackage{bbm}
---

## Introduction
In this report, I explore the Motor Trend Car Road Tests dataset and analyze the relationship between weight (wt), miles per gallon (mpg), and the number of cylinders (cyl). In the first section, I exam the distribution and relationship of wt and mpg. Next, I check if the distribution of wt and mpg depends on cyl. Last, I run a permutation test to see if the relationship of wt and mpg depends on cyl.


### Data Description
The motor trend car road tests dataset [^1] contrains data extracted from the 1974 Motor Trend US magazine, and comprises fuel consumption and 10 aspects of automobile design and performance for 32 automobiles (1973–74 models).[^2] 

[^1]: Henderson, H., & Velleman, P. (1981). Building Multiple Regression Models Interactively. Biometrics, 37(2), 391-411. doi:10.2307/2530428 [Accessed: 24-Jan-2021]

[^2]: T. McElroy, “Ma189Homework2” [Online]. Available: https://github.com/tuckermcelroy/ma189/tree/main/Data [Accessed: 24-Jan-2021]

#### Metadata [^3]
1. **model**: the car model
2. **mpg**: Miles/(US) gallon
3. **cyl**: Number of cylinders
4. **disp**: Displacement (cu.in.)
5. **hp**: Gross horsepower
6. **drat**: Rear axle ratio
7. **wt**: Weight (lb/1000)
8. **qsec**: 1/4 mile time
9. **vs**: V/S
10. **am**: Transmission (0 = automatic, 1 = manual)
11. **gear**: Number of forward gears
12. **carb**: Number of carburetors

[^3]: Christian, Motor Trend Car Road Analysis, Dec-2014. [Online]. Available: https://rstudio-pubs-static.s3.amazonaws.com/51431_3323677bd16347fd983ba69d2aac5d64.html. [Accessed: 13-Jan-2021].

#### Load Data
```{r}
df = read.csv('mtcars.csv', header = TRUE)
head(df)
```

## Body

### 1. Weight vs Miles Per Gallon
First, I'm going to plot a scatter plot of Weight vs Miles Per Gallon to observe  distribution.
```{r}
plot(df$wt, df$mpg, main="Weight vs Miles Per Gallon",
   xlab="Car Weight ", ylab="Miles Per Gallon ")
```
<br/>
From the plot we cn see that as the Car Weight increases, the Miles Per Gallon decreases and there doesn't seems to have any outliers. The data point seems to be generated from a linear model. The following analysis will be based on the assumption that wt and mpg is generated by a linear model.  

Next, I use the code below to get the correlation of the two variable. 
```{r}
cor(df$wt, df$mpg)
```

The function below fits a linear regression model to our data:
```{r}
lm(df$mpg ~ df$wt)
```


### 2. Weight vs Miles Per Gallon vs Number of Cylinders

```{r}
library(plotly)
fig <- plot_ly(df, x = ~wt, y = ~mpg, z = ~cyl, color = I("blue"), alpha = 0.5, size = 1)
fig <- fig %>% add_markers()
fig <- fig %>% layout(scene = list(xaxis = list(title = 'wt'),
                                   yaxis = list(title = 'mpg'),
                                   zaxis = list(title = 'cyl')))
fig
```

From the graph, we can see that there are only three possible values for Number of Cylinders, which are 4, 6, and 8.
There are a clearly different  distribution of Weight and Mules Per Gallon for different value of Number of Cylinders. We plot the wt vs mpg plot subject to each cyl and compute the grouped mean and variance of Weight and Miles Per Gallon.

#### Plots:
```{r}
par(mfrow=c(1,3))
d1 = df[df$cyl == 4, ] 
d2 = df[df$cyl == 6, ] 
d3 = df[df$cyl == 8, ] 
plot(d1$wt, d1$mpg, main="4 Cylinders",
   xlab="Car Weight ", ylab="Miles Per Gallon ",xlim=c(1, 6), ylim=c(0,35))
plot(d2$wt, d2$mpg, main="6 Cylinders",
   xlab="Car Weight ", ylab="Miles Per Gallon ",xlim=c(1, 6), ylim=c(0,35))
plot(d3$wt, d3$mpg, main="8 Cylinders",
   xlab="Car Weight ", ylab="Miles Per Gallon ",xlim=c(1, 6), ylim=c(0,35))
```
#### Grouped Mean:
```{r}
aggregate(df[, c(2,7)], list(df$cyl), mean)
```
#### Grouped Variance:
```{r}
aggregate(df[, c(2,7)], list(df$cyl), var)
```
#### Grouped Covariance:
```{r}
d1 <- df[df$cyl == 4, ] 
d2 <- df[df$cyl == 6, ] 
d3 <- df[df$cyl == 8, ] 
cov(d1$mpg, d1$wt)
cov(d2$mpg, d2$wt)
cov(d3$mpg, d3$wt)
```

It's very clear that mpg and wt's distributions depends on cyl. The more Cylinders a car has, the less its mpg is and the heavier it weights. However this doesn't mean the relationship between mpg and wt depends on cyl. I will try to figure that out in the next section.

### 3. Does the relationship of Weight and Miles Per Gallon depends on the Number of Cylinders?

I choose to use a permutation test to test the  dependency. 

p value threshold: 0.05
Null Hypothesis: The relationship of wt and mpg doesn't depends on cyl. Therefore, the regression slope wt vs mpg of the grouped data should be about the same as the ungrouped data.
Alternative Hypothesis: The relationship of wt and mpg does depends on cyl.

Under null hypothesis, the slope of wt and mpg should be -5.344 as the ungrouped data. So, I choose to use the mean absolute distance between (slope when cyl = 4, slope when cyl = 6, slope when cyl = 8) and (-5.344, -5.344, -5.344) as the test statistic.

#### Compute the observed statistic.
```{r}
get_slopes <- function(df){
  d1 <- df[df$cyl == 4, ] 
  d2 <- df[df$cyl == 6, ] 
  d3 <- df[df$cyl == 8, ] 
  s1 <- lm(d1$mpg~d1$wt)$coefficients[2]
  s2 <- lm(d2$mpg~d2$wt)$coefficients[2]
  s3 <- lm(d3$mpg~d3$wt)$coefficients[2]
  c(s1,s2,s3) 
}
null_dist <- c(-5.344, -5.344, -5.344)
obs_dist <- get_slopes(df)
obs_stats  <- mean(abs( obs_dist- null_dist))
sprintf("observed slopes: %f, %f, %f", obs_dist[1],obs_dist[2],obs_dist[3])
sprintf("observed statistic = %f",obs_stats)
```

Next, we shuffle the label (cyl) and calculate the simulated statistic. This process is repeated for 10000 time.

```{r}
N = 10000
results<-vector('list',N)
for(i in 1:N){
  simulation <- transform( df, cyl = sample(cyl) )
  sim_dist <- get_slopes(simulation)
  results[[i]]<-  mean(abs( sim_dist- null_dist))
}
```

#### plot the results:
```{r}
sim <- data.frame(difs = unlist(results))

ggplot(sim, aes(x=difs)) +
  geom_histogram(color="black", fill="green", alpha=.4) +
  geom_vline(color="navy",lwd=1,lty=2,xintercept = obs_stats) +
  theme_classic()+
  ggtitle("Test statistic of simulated data")
```

#### Calculate p value:
```{r}
mean(results >= obs_stats)
```


## Conclusion
1. In the first part, I use the linear regression model to estimate the relationship of wt and mpg. Wt and mpg have a high correlation of -0.86. The slope of wt vs mpg is -5.344 and the intercept is 37.285. 

2. In the second part, we can see that the distribution of wt and the distribution of mpg depends on cyl. As cyl increases, mpg decreases and wt increases. This conclusion is based on grouped mean and variance and observing the distributions in scatterplots.

3. In the last part, I do a permutation test to see if the relationship of wt and mpg depends on cyl. The resulting p value is lower then the threshold I set. Therefore I reject the null hypothesis, which means the relationship depends on cyl.

4. Based on the assumption that the dataset we get is randomly sampled from the population. The estimators I used in this project are sampled Mean, Variance, Covariance and the slope of a linear regression model.

4.1. Sample mean is an unbiased estimator as the expectation of the sample mean is the exactly the population mean. Samlpe variance and Covariance are also unbiased estimators following the same logic.

4.2. If we assume the true distribution of wt vs mpg follows a linear model, the slope of linear regression model is a unbiased estimator.
